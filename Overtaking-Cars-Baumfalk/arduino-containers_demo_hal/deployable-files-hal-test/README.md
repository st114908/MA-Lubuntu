# Deployable Code

The deployable code rearranges the generated code and rewquires the following adaptions:

## mosquitto

The generated Docker configuration for starting up a mosquitto MQTT Sever, see ```README.txt```.
Copied from the generated code without adjustments.

## README.txt

The README file generated by the Arduino Container Code generator.
Copied from the generated code without adjustments.

## ECU Directories

The ECU directories are copied from the generated code including all contained file.

### Preparing the Generated Component Code
The files of the component code generation in the ```fastAndSlowCar_v2``` directory of the generated code will be moved into different ECU directories.
Before that, some adjustments have to be made to the file content:
* The include statements need to be adjusted for all copied files. Because the files won't be arranged in further subdirectories for the deployment, remove all preceding paths in include statement so that only the name of the included file remains.
* For all header files in the ```components```subdirectory: The ```clock.h``` file must pulled up to be outside of the ```extern "C" {...}``` part!

### Adding the Generated Component Code

After that, the prepared files from the ```fastAndSlowCar_v2``` directory of the generated code are added to specific ECU directories of the deployable code.

In the following, this is explained for each subdirectory of the ```fastAndSlowCar_v2``` directory:
* components
    * The ```coordinatorComponent``` files are added to both ```CoordinatorECU``` directories
    * The remaining files are added to the ```DriverECU``` directories
* lib
    * the files ```clock.h``` and ```standardTypes.h``` are not used
    * the other files are copied to all ECU directories
* messages
    * ```messages_types.h``` is copied to all ECU directories
* operations
    * the files are copied only to the ```DriverECU``` directories
* RTSCs
    * ```coordinatorCoordinatorComponentStateChart.c``` is copied to the ```CoordinatorECU``` directories
    * ```driveControlDriveControlComponentStateChart.c``` is copied to the ```DriverECU``` directories
* types
    * the files are copied to all ECU directories
* The files ```CMakeLists.txt``` and ```Doxyfile``` are not used

Additionally, the files from the APIMappings folder must be moved as well:
* Move the files named like ```...F...``` into the folder of the fast car driver ECU folder.
* Move the files named like ```...S...``` into the folder of the slow car driver ECU folder.


### Adding and Integrating the HAL

For the deployment through the Arduino IDE, the HAL must be installed into the Arduino IDE first, as described [here](https://github.com/SQA-Robo-Lab/Sofdcar-HAL#installation).

Additionally, the following changes to the generated code were made to integrate the HAL:
* Add the config file from [here](https://github.com/SQA-Robo-Lab/Sofdcar-HAL/blob/main/examples/SimpleHardwareController/Config.hpp) to both driver ECU directories.
    * Change the config to the desired parameter settings
* Add the initialization of the HAL in the ```fastCarDriverECU.ino``` and the ```slowCarDriverECU.ino```, as described in https://github.com/SQA-Robo-Lab/Sofdcar-HAL/blob/main/examples/SimpleHardwareController/SimpleHardwareController.ino
    * Include the following library files: `SimpleHardwareController.hpp` and `SimpleHardwareController_Connector.h`
    * Add the global Variable `SimpleHardwareController fastCarDriverController;` in the `.ino`-File (name the var to taste)
    * In the `setup()` function user code section of the `.ino` file add the following lines to initialize the HAL and provide it to the C-Connector:
        * `initSofdcarHalConnectorFor(&fastCarDriverController);`
        * `fastCarDriverController.initializeCar(config, lineConfig);`
    * Call the loop funciton of the HAL in the `loop()` function of the sketch: `fastCarDriverController.loop();`
* Fill the method stubs in the API Mapping files
    * In every API-Mapping include: (recommended in the `.c` file, not the `.h` file to only have the import localy) `SimpleHardwareController_Connector.h`:
    * frontDistance: ```*distance = SimpleHardwareController_DistanceSensor_GetDistanceToClosestMm(0);```
    * rearDistance: ```*distance = SimpleHardwareController_DistanceSensor_GetDistanceToClosestMm(1);```
    * velocity: ```*velocity = SimpleHardwareController_DriveController_GetSpeed();```
* In the ```robotCarPowerTrainOpRep.c``` fill the method stubs in the following way:
    * Include `SimpleHardwareController_Connector.h` at the top of the file (also recommended in the `.c`, not the `.h`)
    * for changing to the left lane use ```SimpleHardwareController_LineFollower_SetLineToFollow(0);```
    * for changing to the right lane use ```SimpleHardwareController_LineFollower_SetLineToFollow(1);```
    * for start driving along the line use ```SimpleHardwareController_DriveController_SetSpeed(velocity);```
* the values for the ```desiredVelocity``` and ```slowVelocity``` can be set individually in the ```driveControlDriveControlComponentStateChart.c``` of the ```...DriverECU``` directories.
    * Also set distance and lanedistance

